# 存储器/内存

## 数据被存入内存

系统的数据/文件读取等操作, 数据会先被存入内存里; 系统内存`Buffer` 与 `Cache` 参数数值会有所变化;

### 细节

buffers与cached都是内存操作，用来保存系统曾经打开过的文件以及文件属性信息，这样当操作系统需要读取某些文件时，会首先在buffers 与cached内存区查找，如果找到，直接读出传送给应用程序，如果没有找到需要数据，才从磁盘读取，这就是操作系统的缓存机制，通过缓存，大大提高了操 作系统的性能。但buffers与cached缓冲的内容却是不同的。

buffers是用来缓冲块设备做的，它只记录文件系统的元数据（metadata）以及 tracking in-flight pages，而cached是用来给文件做缓冲。更通俗一点说：buffers主要用来存放目录里面有什么内容，文件的属性以及权限等等。而cached直接用来记忆我们打开过的文件和程序。

## 手动释放内存

配置文件: `/proc/sys/vm/drop_caches`

操作: 

1. `sync` 将内存同步到磁盘里; 避免释放内存, 内存数据丢失
2. `echo 3 > /proc/sys/vm/drop_caches`

参数意义:

```
0 – 不释放
1 – 释放页缓存
2 – 释放dentries和inodes
3 – 释放所有缓存
```

## Page Cache

为了在速度和容量上折中，在CPU与RAM之间使用CPU cache以提高访存速度，在RAM与磁盘之间，操作系统使用page cache提高系统对文件的访问速度。

写流程：向硬盘写文件时，默认异步情况下，并不是直接把文件内容写入到硬盘中才返回的，而是成功拷贝到内核的page cache后就直接返回，所以大多数情况下，硬盘写操作不会是性能瓶颈。写入到内核page cache的pages成为dirty pages，稍后会由内核线程pdflush真正写入到硬盘上

### 内核处理流程

1. 内核在处理文件I/O请求时，在page cache中查找`(page cache中的每一个数据块都设置了文件以及偏移信息)`

如果未命中，则启动磁盘I/O，将磁盘文件中的数据块加载到page cache中的一个空闲块，之后copy到用户缓冲区中。(先拷贝到内核态，再拷贝到用户态)

2. 为避免在内核区与用户区都缓存两份数据，利用mmap进行映射；

当程序访问到目标空间时，产生缺页中断。在缺页中断中，从page cache中查找要访问的文件块，若未命中，则启动磁盘I/O从磁盘中加载到page cache，然后将文件块在page cache中的物理页映射到进程mmap地址空间。

3. page cache的生命周期：程序退出或关闭文件时，在内存充足情况下，系统不会马上清除page cache中的相应页面；当内存不足时，内核会主动清除数据

### 缓存与磁盘一致性处理

#### 回写同步数据策略

1. 新数据写入时，优先写入page cache;

2. 被写入的页面标记为“脏”，并且将这些“脏”页面加入到脏链表中

3. 回写线程(flusher线程：多线程，避免阻塞等待)会将脏链表中的脏页刷新到磁盘中，最终做到保证磁盘和内存中数据的一致性

#### 触发回写时机

1. 空闲内存低于设置的阈值(`/proc/sys/vm/dirty_background_ratio`设定); 内核必须回写数据以释放内存; 当干净页数量足够多时，内核就会收缩缓存，释放内存

2. 存储时间超过一个阈值后，内核必须将脏页回写入磁盘，确保脏页不会无限期驻留内存

3. 调用sync()和fsync()，内核会将数据回写进磁盘

### buffer cache 与 page cache

两者也称为具备合并关系

#### buffer cache 

1. buffer指的是以前块设备层中用来缓存磁盘内容的结构，一个buffer大小就是磁盘中一个block的大小。

2. 主要描述对象是指磁盘；没有文件系统，文件目录的概念

#### page cache

1. 应用文件系统层用于缓存读写内容的cache，因为这一层在设备层之上，因此和内核其他地方一样，以page为单位来管理

2. 在mmap过程里的，起到缓存文件作用

### 缓冲区的重要性

1. 缓和处理器与I/O设备间速度不匹配的矛盾。处理器的运算速度会远高于I/O设备的速率；设置缓冲区, 能提高处理器效率，避免等待I/O

2. 减少处理器中断频率，放宽处理器中断响应时间的限制；处理器接收远端数据都需发生中断；设置缓冲区，可存放缓冲区，降低中断响应时间

3. 因为降低了处理器与I/O设备的相互等待程度，从而提高了处理器与I/O设备之间的并行性

#### 循环缓冲区

环形数组；拥有读指针与写指针

