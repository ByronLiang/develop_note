# etcd分布式kv raft算法 CAP理论分析

## CAP理论

## etcd

etcd是满足CP的分布式应用; CP是指`(C)`一致性; `(P)`分区容错性; 放弃可用性`(A)`

### CAP理论分析

raft是强leader型算法，客户端使用etcd服务只能通过leader进行；AB分区后，不存在leader，所以无法对外提供服务，之前连接AB节点的客户端将无法获取服务；体现无法满足可用性;

客户端无法感知leader发生变换，它将请求交给AB时，因为AB知道自己不是leader，但同时也不知道leader是谁，所以会向客户端响应轮询节点更换，找到新的leader。

因为分区后AB服务对外提供读写服务，之前连接AB的客户端会受此影响，所以会增加请求读时间，这里就体现了raft协议满足了CAP中的CP，而没有满足A

#### 分布式系统与CAP特点

对于P，在分布式环境下P一定存在，这时再考虑CA;在单机下，P不会存在，CA则必定存在。

P存在，要求C，则在网络分区后，要求数据一致，就需要放弃一部分服务的可用性。
P存在，要求A，则在网络分区后，要求所以节点仍能提供服务，这必定会带来分区间的数据不一致。
P不存在，就是单机环境了，单机下CA是一定存在

#### 理论应用

1. CP理论: 分布式数据库(redis/zk/etcd)
2. AP理论: 商城(库存数量) 确保功能可用, 数据一致性暂无法及时满足
3. CA理论: 只满足单机需求，无法实现服务扩展

### Quorum 法定人数机制

### WARO (Write All Read One)副本控制协议

当主节点请求向某副本写数据时（更新数据），只有当所有的副本都更新成功之后，写操作才算成功，否则视为失败。可用性较低

### Quorum机制详情

1. 按照集群节点里`n/2 + 1`，能正确响应主节点的请求，则能成功提交数据

2. 对于读操作，能从`n/2 + 1`节点里，读取到最新数据，则保证读取最新的数据

3. 在一定情况下，在满足`n/2 + 1`节点可响应情况下，需要容忍一部分无法响应的集群节点

#### 节点数目与Quorum机制关系

1. 尽量确保为奇数个数的副本节点：能具备最大可容忍失败的节点；

说明：如节点数为3与节点数为4，它们最大可容忍失败节点数都为1；即便新加一个节点服务器，未必能提高最大可容忍失败节点数

