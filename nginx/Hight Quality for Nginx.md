# Nginx 高可用细节记录

## 支撑高可用的细节

- Nginx 采用多进程+异步非阻塞方式（IO 多路复用 Epoll）。
- 请求的完整过程：建立连接→读取请求→解析请求→处理请求→响应请求。
- 请求的完整过程对应到底层就是：读写 Socket 事件。

## Nginx 处理连接

1. Nginx 启动时，Master 进程，加载配置文件。
2. Master 进程，初始化监听的 Socket。
3. Master 进程，Fork 出多个 Worker 进程。
4. Worker 进程，竞争新的连接`(accept_mutex) 理解为共享锁`，获胜方通过三次握手，建立 Socket 连接，并处理请求。
5. event模块里, 参数`multi_accept` 主进程决定对子进程处理请求(一个个的)

## 惊群问题

### 起因

master进程首先通过 socket() 来创建一个 sock 文件描述符用来监听，然后fork生成子进程（workers 进程），子进程将继承父进程的 sockfd（socket 文件描述符

之后子进程 accept() 后将创建已连接描述符（connected descriptor），然后通过已连接描述符来与客户端通信。

连接进来时，所有子进程都将收到通知并“争着”与它建立连接；当最终只有一个子进程能获取连接

### 优点

1. 当并发请求量大时，能保证一定的吞吐量, 请求效率高

### 缺点

1. 所有子进程都被唤醒，若进程数量较大，易引发资源消耗(上下文切换, 负载上升)

### 参数配置 accept_mutex

- `connection processing methods` 使用`epoll`方式, 通过`EPOLLEXCLUSIVE`标志, 解决惊群问题：不让多个进程在同一时间监听接受连接的socket，而是让每个进程轮流监听，这样当有连接过来的时候，就只有一个进程在监听;

- `accept_mutex` 参数默认是关闭；

## I/O模式 epoll 高效分析

1. 使用I/O模型下的内存共享（mmap）;

`mmap` 通过映射一个普通的文件实现共享内存。普通文件映射到进程地址空间后，进程可以向访问内存的方式对文件进行访问，不需要其他系统调用(read,write)去操作。

2. 使用红黑树(有序二叉树)数据结构存储epoll所监听的套接字

 一个fd被添加到epoll中之后`epoll_ctl的epoll_ctl_add模式`，内核会为其生成一个对应的epitem结构对象，然后epitem会被添加到红黑树中，红黑树的作用就是在添加、删除、修改fd时，能够快速实现

3. 非阻塞异步机制; 就绪事件(fd)添加进入双向链表里;

`ep_poll_callback`: 这个回调函数把事件添加到rdllist这个双向链表中。一旦有事件发生，epoll就会将该事件添加到双向链表中。那么当我们调用epoll_wait时，epoll_wait只需要检查rdlist双向链表中是否有存在注册的事件

### select，poll，epoll 的相关I/O

1. I/O多路复用机制; 本质上都是同步I/O，在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的，而异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间。 

#### select

select本质上是通过设置或者检查存放fd标志位的数据结构来进行下一步处理。这样所带来的缺点是：

1、 单个进程可监视的fd数量被限制，即能监听端口的大小有限。

2、 对socket进行扫描时是线性扫描，即采用轮询的方法，效率较低：

当套接字比较多的时候，每次select()都要通过遍历FD_SETSIZE个Socket来完成调度,不管哪个Socket是活跃的,都遍历一遍。这会浪费很多CPU时间。如果能给套接字注册某个回调函数，当他们活跃时，自动完成相关操作，那就避免了轮询，这正是epoll与kqueue做的。

3、需要维护一个用来存放大量fd的数据结构，这样会使得用户空间和内核空间在传递该结构时复制开销大

#### poll

poll与select相似; 主要区别是使用链表存储fd, 可监视的fd数量是无限制的;

#### epoll 分类

1. epoll水平触发: 默认方式; 系统中一旦有大量你不需要读写的就绪文件描述符
它们每次调用epoll_wait都会返回，这样会大大降低处理程序检索自己关心的就绪文件描述符的效率

2. epoll边缘触发: 当被监控的文件描述符上有可读写事件发生时，epoll_wait()会通知处理程序去读写。
如果这次没有把数据全部读写完(如读写缓冲区太小)，那么下次调用epoll_wait()时，它不会通知你，也就是它只会通知你一次，直到该文件描述符上出现第二次可读写事件才会通知你

总结: 

1. epoll边缘触发方式效率更高;

2. select 与 poll 都只有水平触发; epoll具备两种触发方式;
