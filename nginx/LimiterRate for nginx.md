# Nginx 处理限流相关笔记

## 限流的核心算法

### 漏斗算法(Leaky Bucket)

1. `Traffic Shaping`: 暂时拦截住上方水的向下流动，等待桶中的一部分水漏走后，再放行上方水。[只能Nginx实现]
2. `Traffic Policing`: 溢出的上方水直接抛弃。[可使用Redis与Nginx实现]

### Nginx 源码实现

#### limit_req模块实现限流业务: 

```sh
limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s;
 
server {
    location  /search/ {
        limit_req zone=one burst=5 nodelay;
    }
}
```
- `limit_req_zone`初始化配置限流的方案：

1. `$binary_remote_addr`: 表示通过remote_addr这个标识来做限制，`binary_`的目的是缩写内存占用量，是限制同一客户端ip地址
2. `zone=one:10m`: 表示生成一个大小为10M，名字为one的内存区域，用来存储访问的频次信息
3. `rate`: 访问频率 单位: `r/s`, `r/m` (每秒可处理的请求数目，每分钟可处理的请求数目)
4. `burst` 当不设置时, 超出频率的请求将被直接抛弃(状态码: 503); 当burst被设置数值, 则超过了访问频次限制的请求可以先放到这个缓冲区内等待，但是这个等待区里的位置只有设置数值个数，超过的请求会直接报503的错误然后返回。

- 通过在location里指定不同的路径, 可以采取不同的限流标识名称

#### burst参数的算法

burst参数主要采用了令牌桶算法。令牌桶算法用来控制发送到网络上的数据数目，并允许突发数据的发送。

- 算法差异点：

1. `漏斗算法`能够强行限制数据的传输速率
2. `令牌桶算法`在能够限制数据的平均传输数据外，还允许某种程度的突发传输。突发传输将被放置于等待区；只要令牌桶中存在令牌，那么就允许突发地传输数据直到达到用户配置的门限，因此它适合于具有突发特性的流量

