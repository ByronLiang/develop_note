# 发号器平台设计

## 核心设计

### 雪花算法 snowflake

由于依赖时间戳生成随机号, 不同机器的机器时间需要一致, 若机器时间不一致，会引发随机号出现重复现象`(时间回拨现象)`

#### 处理时间回拨现象

- 识别到时间差异, 进行等待处理，确保下一次请求不再出现有时间差

- 保留位数来记录是否属于时间回拨而生成随机号, 即便随机号重复，但因为标识不同, 最终生成号码也不会重复

### 分段式取号

#### 业务特点

- 业务隔离, 不同的key进行区分

- 防止重复发号

- 进程结束, 可根据实际，将未分发的号码重新放回

- 并发量, 可用性, 限流等措施

#### 自增特性

确保业务内，号码呈现递增规律, 适合 IM 平台聊天历史的序列号，增量消息

#### 设计

1. 对于多段式发号与进程内存存储方式，无法使用多服务节点的负载均衡, 容易造成服务节点取号位置不一致，无法呈现单调递增。只能采用 一主 多个从机, 进行故障转移, 避免单点故障导致无法发号; 客户端只能向主机器获取号码

2. 当号段消费到一定比例后, 提前申请新一批号段, 避免号段全部消费完, 因申请过程异常, 无法获取号码从而服务不可用

### 全局唯一业务

无需确保递增规律, 只需要确保唯一, 适合订单号、文章ID与分库分表的主键ID

#### 设计

可以多服务节点，负载均衡, 不同节点取不同分段号码, 预留可取的号码

每当取一批新号码时，需要分布式锁/MySQL悲观锁, 避免并发产生重复号码
