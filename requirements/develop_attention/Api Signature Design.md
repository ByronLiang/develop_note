# API 接口验签 与 请求参数防改动

## 验签流程

1. 提取header里的验签参数; 检测`timestamp`有否超出有效期; `nonce`是已存在

2. 提前请求参数, 并加入`timestamp` 进行密匙生成(依据算法进行处理)，并与请求的签名比较

3. 签名匹配, 将本次的`nonce`进行保存, 设定过期时长; 然后放行此次请求;

## 验签开发/参数配置

1. 接口验签作为请求中间件进行设计(网关层验证); 作为一种拦截器作用; 

2. 验签的参数一般放置在请求header里; 命名可以`x-safe-*` 

3. 基本参数主要: `signature`, `timestamp`, `nonce`; 若加上`app_id/app_secret`实现多租户的对外接口调用业务

### signature

1. 生成算法: 签名生成与验证需要使用统一加密算法: HMAC_SHA_256、md5, DES对称加密(客户端与服务端密匙加密解密)

2. 生成流程:
    - 所有请求参数按key做的升序排列
    - 参数名和参数值连接成字符串，得到拼装字符
    - 字符串里加上`timestamp`值; 为此签名设立时效性， 时效长度由验签方(服务端)决定

### timestamp

1. 需确保移动端与服务器时间戳一致；避免因超出有效时长, 引发签名失效异常

2. 有效时长的长度 与 当前参数的数值, 实现当前签名的有效时长;

3. `timestamp` 的有效时长的配置与 `nonce`的有效时长是一致的;

### nonce

1. 客户端生成唯一的，作为一个在加密通信只能使用一次的字符串; 验签成功后, 服务端进行保存， 并设置过期时长

2. 在首次请求时，已经被存储到了服务器上的“集合”中，再次发送请求会被识别并拒绝

## 总结

1. `timestamp`参数作用，起到确保签名具有一定时效性；只能在时效性里发起重放攻击

2. `timestamp` 与 `nonce 唯一性` 组合, `nonce`的存储时长只需与 `timestamp` 的 有效时长一致即可; `nonce`集合无需长期占用存储空间
