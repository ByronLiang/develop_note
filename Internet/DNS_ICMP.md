# DNS协议与解析

## 域名结构与理论

1. 一定具备顶级域名`(通用顶级域名: .com等)`；另外包含四级域名、三级域名或者二级域名组成；

2. 域名是分层结构，域名服务器也是对应的层级结构

3. DNS协议是基于UDP传输协议, 没有建立连接的概念

## 域名请求与解析流程

情景: 浏览器访问一个域名地址;

- 域名服务器流程

    1. 主机先向本地域名服务器`(/etc/hosts)`进行递归查询
    2. 本地域名服务器采用迭代查询，向一个根域名服务器进行查询
    3. `根域名服务器`告诉`本地域名服务器`，下一次应该查询的顶级域名服务器的IP地址
    4. `本地域名服务器`向`顶级域名服务器`进行查询
    5. `顶级域名服务器`告诉`本地域名服务器`，下一步查询权限服务器的IP地址
    6. 本地域名服务器向权限服务器进行查询
    7. 权限服务器告诉本地域名服务器所查询的主机的IP地址
    8. 本地域名服务器最后把查询结果告诉主机

- 客户端获取到主机IP, 将发起TCP传输协议的Http请求，与服务器进行通信

### Go SDK Http Client 域名请求都会进行 DNS 解析

在业务代码里，对每个host 进行 IP 解析，并进行进程缓存, 减少每次发起请求，都进行 host 的 DNS 解析

#### 一个 host 域名下多 IP 地址选取策略

通过 ICMP (ping) 检测 每个 IP 的网络连通性，通过选取低时延的 IP 地址，提高请求响应效能，并做到 IP 负载均衡

ICMP 协议是TCP/IP协议簇的一个子协议。可以理解归属于 `网络层`；ping 请求不依赖 TCP/UDP 进行传输。

Windows 系统的tracert是用ICMP协议的 echo request（ping）探测；但Linux 系统的traceroute是用udp包进行探测
