# RabbitMQ 高可用笔记

## 生产者确认

### 事务机制

- 消息成功被RabbitMQ接收, 事务才能提交成功，否则可在捕获异常之后进行事务回滚，同时可以进行消息回滚

- 事务流程会影响消息队列系统的吞吐量性能

#### 流程

1. txSelect() 设置成事务模式
2. basicPublish 投递消息
3. 若捕获异常, 进行事务回滚(txRollback); 若投递成功, 提交事务(txCommit)


### 发送方确认机制(publisher confirm)

- 发送方确认机制与事务机制是互斥；事务机制具有阻塞性，而publisher confirm 具有异步性；

- 生产者通过对回调来处理投递成功(Ack)与投递失败(Nack)两种响应处理

#### 流程

1. confirmSelect() 信道开启发送方确认机制
2. basicPublish 投递信息
3. 执行Ack的回调/Nack的回调逻辑业务

## 消费者消息

### 消息顺序性

- 按照顺序性，在消费消息里进行为生产者产生下一个顺序的消费消息
- 消息体内添加全局有序标识(Sequence ID)

### 消息处理幂等性

#### 版本号方案

- 流程

1. 消费者只处理比当前版本号大的消息
2. 当发送消息的顺序不一致时，先将版本号大的消息进行保存, 待前一版本号的消息到达时，再取出进行处理

- 缺点

1. 发送方的消息需要携带业务版本号
2. 消费者端需要存储对应流程里的版本号

#### 状态机

- 流程

1. 消费者定义各种状态的流转关系；若接收到的消息与状态关系不一致，则存在消息重发/顺序到达出错

2. 对不符消息进行重发处理，当达到重发次数，然后停止重发
