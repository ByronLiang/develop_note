# RabbitMQ 基本知识

- 主要使用Erlang开发语言 [面向并发的编程语言]
- 并以AMQP的消息队列协议

## 消息队列作用

- 本质是个队列，FIFO先入先出；不同进程/线程之间通信

- 解耦: 可看作一个隐含的、基于数据层的接口层；生产者与消费者都能独立地扩展或修改两边的处理过程；确保遵守同样的接口约束；

- 消息持久化: 规避数据丢失风险；即便处理数据过程失败，能确保数据保存到直到使用完毕或者自动丢弃的效果；

- 可恢复性: 处理消息进程挂掉, 系统恢复后也能继续处理；

- 缓冲/异步通信: 控制和优化数据流过系统的速度

## AMQP协议

AMQP协议具体使用`AMQP-0-9-1` RabbitMQ 的交换器、交换器类型、队列、绑定和路由键都遵循AMQP协议中的相应概念

- Module Layer: 协议最高层，定义客户端调用的命令, 实现业务逻辑

- Session Layer: 协议中间层; 客户端和服务端之间的通信提供可靠性同步机制和错误处理

- Transport Layer: 协议最底层; 传输二进制数据流，提供帧的处理、信道复用、错误检测与数据表示；

- 属于一种通信协议，从协议的底层看作是属于应用层的协议，填充TCP协议层的数据部分；
从协议的高层可以看作是一种类似HTTP的结构化命令集合；

## 基本运转流程

#### 生产者

1. 生产者连接RabbitMQ Broker, 建立一个连接(Connection), 开启一个信道(Channel)
2. 声明一个交换器, 设置属性(名称、类型与持久化)
3. 声明队列，设置属性(名称、排他性、持久化与自动删除)
4. 设置一个路由键(Route Key) 绑定交换器与队列
5. 发送并配置消息属性(发送模式、路由键或者交换器信息) 到RabbitMQ Broker
6. 可加入消息发送确认机制, 来确保消息成功发送到指定队列里
7. 基于实际情况，消息可被丢弃或者回退给生产者
8. 关闭信道
9. 关闭连接

#### 消费者

1. 建立连接，开启信道
2. 向RabbitMQ Broke 请求消费相应的队列中的消息，设置回调函数进行处理业务逻辑
3. 自动/手动发出确认(ack)接收信息
4. 队列删除已经确认的消息
5. 关闭信道、关闭连接

### 连接与信道的连接问题

- 通信连接采用TCP连接复用，避免建立与销毁TCP的连接

- 每个线程负责一个信道，信道复用了Connection的TCP连接，并且确保每个线程的独立性；复用单一的Connection可以有效节省TCP连接资源

