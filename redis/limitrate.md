# Laravel 框架限流逻辑与 Redis实现相关限流

## ThrottleRequests 中间件限流流程

### 原理

- Laravel框架里主要运用计数器原理, 控制单位时间内的请求数量
- 配置最大访问数、访问时间差，基于同一IP或同一用户ID(若处于登陆状态)作为统计对象
- 使用`Hash`数据结构: key: 请求用户的IP/用户ID的哈希值, value: 存储请求数量, 开始时间与到期时间时间戳
- 使用Lua脚本保证原子性数据操作

### 缺陷

1. 不能有效平均地分流请求和容易超出每秒钟处理数量的阈值；

假设在 00:01 时发生一个请求,在 00:01-00:58 之间不在发送请求,在 00:59 时发送剩下的所有请求 n-1 (n为限流请求数量),在下一分钟的 00:01 发送n个请求,这样在2秒钟内请求到达了 2n - 1 个；


## 令牌桶算法

### 原理

1. 系统会按恒定 1/QPS 时间间隔 (如果 QPS=100, 则间隔是 10ms) 往桶里加入 Token；如果桶已经满了就不再加了。新请求来临时，会各自拿走一个 Token, 如果没有 Token 可拿了就阻塞或者拒绝服务.
2. 可以方便的改变速度。一旦需要提高速率，则按需提高放入桶中的令牌的速率。一般会定时 (比如 100 毫秒) 往桶中增加一定数量的令牌，有些变种算法则实时的计算应该增加的令牌的数量.
3. 使用`list`数据结构；原子性操作: `rPop`消费令牌；`lPush`补充令牌

### 应用

1. 可定时补充令牌, 保证阻塞时间不过长；保证不超出令牌桶的容积，按照间隔时长补充一定数目的令牌数
2. 可设置固定的令牌数目并且不进行令牌补充(秒杀类请求: 秒杀商品库存: 100, 设置令牌数目为100, 拦截超过令牌数目的请求)
3. 令牌桶的对象可基于单一IP与单一用户ID; 也可针对所有请求进行限流
